/*
 2015-2021 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires jQuery jstree 3.0.3
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(c,t,u){c instanceof String&&(c=String(c));for(var f=c.length,m=0;m<f;m++){var n=c[m];if(t.call(u,n,m,c))return{i:m,v:n}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(c,t,u){if(c==Array.prototype||c==Object.prototype)return c;c[t]=u.value;return c};$jscomp.getGlobal=function(c){c=["object"==typeof globalThis&&globalThis,c,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var t=0;t<c.length;++t){var u=c[t];if(u&&u.Math==Math)return u}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(c,t){var u=$jscomp.propertyToPolyfillSymbol[t];if(null==u)return c[t];u=c[u];return void 0!==u?u:c[t]};
$jscomp.polyfill=function(c,t,u,f){t&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(c,t,u,f):$jscomp.polyfillUnisolated(c,t,u,f))};$jscomp.polyfillUnisolated=function(c,t,u,f){u=$jscomp.global;c=c.split(".");for(f=0;f<c.length-1;f++){var m=c[f];if(!(m in u))return;u=u[m]}c=c[c.length-1];f=u[c];t=t(f);t!=f&&null!=t&&$jscomp.defineProperty(u,c,{configurable:!0,writable:!0,value:t})};
$jscomp.polyfillIsolated=function(c,t,u,f){var m=c.split(".");c=1===m.length;f=m[0];f=!c&&f in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var n=0;n<m.length-1;n++){var b=m[n];if(!(b in f))return;f=f[b]}m=m[m.length-1];u=$jscomp.IS_SYMBOL_NATIVE&&"es6"===u?f[m]:null;t=t(u);null!=t&&(c?$jscomp.defineProperty($jscomp.polyfills,m,{configurable:!0,writable:!0,value:t}):t!==u&&(void 0===$jscomp.propertyToPolyfillSymbol[m]&&($jscomp.propertyToPolyfillSymbol[m]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(m):
$jscomp.POLYFILL_PREFIX+m),$jscomp.defineProperty(f,$jscomp.propertyToPolyfillSymbol[m],{configurable:!0,writable:!0,value:t})))};$jscomp.polyfill("Array.prototype.find",function(c){return c?c:function(t,u){return $jscomp.findInternal(this,t,u).v}},"es6","es3");
(function(c,t){var u=0,f={},m={},n={};c.widget("s3.locationselector",{options:{hideLx:!0,reverseLx:!1,locations:null,labels:null,minBBOX:.05,showLabels:!0,featureRequired:null,latlonMode:"decimal",latlonModeToggle:!0,openMapOnLoad:!1},_create:function(){this.id=u;u+=1;this.eventNamespace=".locationselector"},_init:function(){var b=c(this.element),a=this.options,d=b.attr("id");if(!d)throw"Location selector widget: real input field without id";this.fieldname=d;this.input=b;this.data=null;this._storeHierarchyData(a.labels,
a.locations);this.refresh()},_destroy:function(){c.Widget.prototype.destroy.call(this)},refresh:function(){this._unbindEvents();var b=this._deserialize();this._renderWidget();var a="#"+this.fieldname,d=this.options;c(a+"_geocode button").length?this.useGeocoder=!0:this.useGeocoder=!1;var e=c(a+"_postcode").data("k");this.postcodeToAddress=e?e:!1;e=c(a+"_L0__row");if(e.length){var g=[];for(p in f){var h=f[p];0===h.l&&(h.i=p,g.push(h))}g.sort(function(r,v){return r.n.localeCompare(v.n)});for(var k=
c(a+"_L0"),l=0,q=g.length;l<q;l++){h=g[l];var p=h.i;p='<option value="'+p+'">'+h.n+"</option>";k.append(p)}this.postcodeToAddress||(e.removeClass("hide").show(),e=c(a+"_L0__row1"),e.length&&e.removeClass("hide").show())}var y=this;e=b.L0;g=b.L1;p=b.L2;k=b.L3;l=b.L4;q=b.L5;var w;[e,g||p,p||k,k||l,l||q,q].forEach(function(r,v){r&&(w=w?w.then(function(){return y.lxSelect(v,r,!0)}):y.lxSelect(v,r,!0))});this.lx=[e,g,p,k,l,q].join("|");e=b.address;c(a+"_address").val(e);e?(c(a+"_address__row").removeClass("hide").show(),
c(a+"_address__row1").removeClass("hide").show()):this.postcodeToAddress||(c(a+"_address__row").removeClass("hide").show(),c(a+"_address__row1").removeClass("hide").show());c(a+"_postcode").val(b.postcode);c(a+"_postcode__row").removeClass("hide").show();c(a+"_postcode__row1").removeClass("hide").show();c(a+"_lat").val(b.lat).latloninput({type:"lat",mode:d.latlonMode});c(a+"_lat__row").removeClass("hide").show();c(a+"_lat__row1").removeClass("hide").show();c(a+"_lon").val(b.lon).latloninput({type:"lon",
mode:d.latlonMode});c(a+"_lon__row").removeClass("hide").show();c(a+"_lon__row1").removeClass("hide").show();e=c(a+"_map_icon__row").removeClass("hide").show();b.lat||b.lon||b.wkt?(this.input.data("manually_geocoded",!0),this._showMap()):d.featureRequired?this._showMap():d.openMapOnLoad&&e.is(":visible")&&"#sub_"!=a.substring(0,5)?this._showMap():this._hideMap();this.input.data("input",this._hasData());this.input.prevAll(".throbber").remove();this._bindEvents()},_renderWidget:function(){var b=this.fieldname,
a="#"+b,d=this.options.reverseLx,e=c(a+"_map_icon__row .map_wrapper");e.attr("id",this.fieldname+"_map_wrapper");var g=c(a+"__row"),h=this.input.next(".error_wrapper").addClass("error_top"),k=c(a+"_map_icon__row"),l=c(a+"_L0__row"),q=c(a+"_postcode__row");if(g.is(".control-group, .form-row")){b=c(a+"_L1__row");var p=c(a+"_L2__row"),y=c(a+"_L3__row"),w=c(a+"_L4__row"),r=c(a+"_L5__row"),v=c(a+"_address__row"),x=c(a+"_lat__row"),A=c(a+"_lon__row");a=c(a+"_latlon_toggle__row");d?g.hide().after(e).after(k).after(a).after(A).after(x).after(l).after(b).after(p).after(y).after(w).after(r).after(q).after(v).after(h):
g.hide().after(e).after(k).after(a).after(A).after(x).after(q).after(v).after(r).after(w).after(y).after(p).after(b).after(l).after(h)}else g.parent().is(".inline-form")?g.show():(c(a+"__row1").hide(),g.hide().after(h),k.detach(),g.siblings('[id^="'+b+'"][id$="__row"]').last().after(e).after(k));if(h.length)h.one("click"+this.eventNamespace,function(){var z=c(this);z.fadeOut("slow",function(){z.remove()})})},_lxSelectFinal:function(b){b?this._serialize():this._collectData();this._zoomMap()},lxSelect:function(b,
a,d){var e=c.Deferred(),g=this,h="#"+g.fieldname,k=g.options,l=c(h+"_L"+b),q;a?(l.val(a).trigger("change","implicit"),l.hasClass("multiselect")&&l.multiselect("instance")&&l.multiselect("refresh")):a=parseInt(l.val(),10);if(0===b){var p=g._readLabels(a),y=m.d,w=["1","2","3","4","5"],r,v,x;p.then(function(J){for(x=0;5>x;x++)q=w[x],r=J[q]||y[q],A=h+"_L"+q,l=c(A),v=k.showLabels?l.hasClass("required")?"<div>"+r+':<span class="req"> *</span></div>':r+":":"",c(A+"__row label").html(v),c(A+"__row1 label").html(v),
c(A+' option[value=""]').html(i18n.select+" "+r),l.hasClass("multiselect")&&l.multiselect("instance")&&l.multiselect("refresh")})}p=k.hideLx;for(q=b+1;6>q;q++){var A=h+"_L"+q;p?(c(A+"__row").hide(),c(A+"__row1").hide()):c(A+" option").remove('[value != ""]');c(A).val("").trigger("change","implicit")}if(a){var z=!1,B=b+1,D=c(h+"_L"+B+"__row");D.length||(z=!0,B++,D=c(h+"_L"+B+"__row"));if(D.length){var C;p=!1;if(c(h+"_L"+b+' option[value="'+a+'"]').hasClass("missing")){var E=f[a];E.i=a;var G=[E]}else for(C in G=
[],p=!0,f)if(f[C].f==a){p=!1;break}g._readHierarchy(p,a,B,z).then(function(){if(0==G.length)for(C in f)E=f[C],E.f==a&&(E.i=C,G.push(E));var J=G.length;if(J){G.sort(function(K,L){return K.n.localeCompare(L.n)});var H=h+"_L"+B;var F=c(H),I=c(H+' option[value=""]').html();c(H+" option").remove('[value != ""]');C=null;for(x=0;x<J;x++)E=G[x],C=E.i,H=a==C?' selected="selected"':"",z=E.l==B?"":' class="missing"',H='<option value="'+C+'"'+H+z+">"+E.n+"</option>",F.append(H);if(!g.postcodeToAddress||g.data.address)D.removeClass("hide").show(),
c(h+"_L"+B+"__row1").removeClass("hide").show();F.hasClass("multiselect")&&(I={header:"",height:300,minWidth:0,selectedList:1,noneSelectedText:I,multiple:!1},F.hasClass("search")?(F.multiselect(I).multiselectfilter({label:"",placeholder:i18n.search}),c(".ui-multiselect-header").show()):(I.header=!1,F.multiselect(I)));F=g.data["L"+B];I=G.map(function(K){return K.i});F&&-1!=I.indexOf(""+F)?g.lxSelect(B,F,d):1==J&&C&&g.lxSelect(B,C,d)}g._lxSelectFinal(d);e.resolve()})}else g.useGeocoder&&!d&&g._geocodeDecision(),
g._lxSelectFinal(d),e.resolve()}else g._lxSelectFinal(d),e.resolve();return e.promise()},_collectData:function(b){var a=this.data,d="#"+this.fieldname,e=this._lookupParent(),g=c(d+"_address").val(),h=c(d+"_postcode").val();a.address=g;a.postcode=h;if(a.specific)a.id=a.specific,a.parent=e;else{var k=a.lat,l=a.lon,q=a.wkt;g||h||k||l||q?(a.id=null,a.parent=e):(a.id=e,a.parent=null)}this._serialize();c(d+"_lat").val(a.lat).trigger("setvalue");c(d+"_lon").val(a.lon).trigger("setvalue");this.input.data("input",
this._hasData());"sub_"==this.fieldname.slice(0,4)&&this.input.trigger("change",b&&"user"||"implicit")},_collectLx:function(){var b=this.data,a="#"+this.fieldname,d;for(d=0;6>d;d++){var e=c(a+"_L"+d);e.length&&(e=e.val(),b["L"+d]=e?parseInt(e,10):null)}this._serialize()},_hasData:function(){var b=this.data,a=!1;b.specific||b.address||b.postcode||b.lat||b.lon||b.wkt?a=!0:[b.L0,b.L1,b.L2,b.L3,b.L4,b.L5].join("|")!=this.lx&&(a=!0);return a},_lookupParent:function(){this._collectLx();for(var b=this.data,
a,d=5;-1<d;d--)if(a=b["L"+d])return a;return(b=f.d)?b.i:null},_readLabels:function(b){b||(b="d");var a=c.Deferred(),d=m[b];if(d==t){var e=S3.Ap.concat("/gis/hdata/"+b);c.ajaxS3({url:e,dataType:"json",success:function(g){d={};try{for(var h in g)d[h]=g[h];m[b]=d}catch(k){}a.resolve(d)},error:function(g,h,k){(g="UNAUTHORIZED"==k?i18n.gis_requires_login:g.responseText)&&s3_debug(g);a.reject()}})}else a.resolve(d);return a.promise()},_readHierarchy:function(b,a,d,e){var g=""+a+";"+d+";"+e,h=n[g];if(h!==
t)return h;var k=c.Deferred();if(b){b="#"+this.fieldname;var l=c(b+"_L"+d),q=!1;l.hide();if(l.hasClass("multiselect")){q=!0;var p=c(b+"_L"+d+"__row button").hide()}var y=c(b+"_L"+d+"__throbber").removeClass("hide").show();a=e?S3.Ap.concat("/gis/ldata/"+a+"/"+d):S3.Ap.concat("/gis/ldata/"+a);c.ajaxS3({url:a,dataType:"json",success:function(w){for(var r in w)f[r]=w[r];y.hide();q?p.removeClass("hide").show():l.removeClass("hide").show();k.resolve()},error:function(w,r,v){if(w="UNAUTHORIZED"==v?i18n.gis_requires_login:
w.responseText)s3_debug(w),S3.showAlert(w,"error");y.hide();q?p.removeClass("hide").show():l.removeClass("hide").show();k.reject()}})}else k.resolve();return h=n[g]=k.promise()},_geocodeDecision:function(){var b="#"+this.fieldname,a=this.data;this._collectData();if(S3.gis.geocodeDecisionPlugin)S3.gis.geocodeDecisionPlugin(b,a,this);else if(a.address){a=["1","2","3","4","5"];for(var d=0,e;5>d;d++)if(e=c(b+"_L"+a[d]),e.length&&!e.val()&&1<e[0].options.length)return;c(b+"_geocode .geocode_success,"+
b+"_geocode .geocode_fail").hide();var g=this;a=this.eventNamespace;this.input.data("manually_geocoded")?c(b+"_geocode button").removeClass("hide").show().unbind(a).bind("click"+a,function(){c(this).hide();g._geocode()}):this._geocode()}},_geocode:function(){for(var b=this.fieldname,a=this,d="#"+b,e=c(d+"_geocode .geocode_fail").hide(),g=c(d+"_geocode .geocode_success").hide(),h=c(d+"_geocode .throbber").removeClass("hide").show(),k=this.data,l={address:k.address},q="postcode L0 L1 L2 L3 L4 L5".split(" "),
p=0,y,w;7>p;p++)y=q[p],(w=k[y])&&(l[y]=w);l.k=c(d+"_geocode button").data("k");d=S3.Ap.concat("/gis/geocode");c.ajaxS3({url:d,type:"POST",data:l,dataType:"json",success:function(r){var v=r.lat,x=r.lon;if(v||x){k.lat=parseFloat(v);k.lon=parseFloat(x);a._collectData();v=S3.gis;if(v.maps&&(x=v.maps["location_selector_"+b])){r=x.s3.draftLayer;r.removeAllFeatures();var A=new OpenLayers.Geometry.Point(k.lon,k.lat);A.transform(v.proj4326,x.getProjectionObject());v=new OpenLayers.Feature.Vector(A);r.addFeatures([v]);
a._zoomMap()}h.hide();g.html(i18n.address_mapped).removeClass("hide").show()}else h.hide(),e.html(i18n.address_not_mapped).removeClass("hide").show(),s3_debug(r)},error:function(r,v,x){r="UNAUTHORIZED"==x?i18n.gis_requires_login:r.responseText;h.hide();e.html(i18n.address_not_mapped).removeClass("hide").show();s3_debug(r)}})},_geocodeReverse:function(){var b=this,a="#"+this.fieldname,d=c(a+"_geocode .geocode_fail").hide(),e=c(a+"_geocode .geocode_success").hide(),g=c(a+"_geocode .throbber").removeClass("hide").show(),
h=this.data;h={lat:h.lat,lon:h.lon};h.k=c(a+"_geocode button").data("k");a=S3.Ap.concat("/gis/geocode_r");c.ajaxS3({async:!1,url:a,type:"POST",data:h,dataType:"json",success:function(k){var l=k.L0,q=k.L1,p=k.L2,y=k.L3,w=k.L4;k=k.L5;if(l){b.useGeocoder=!1;var r;[l,q||p,p||y,y||w,w||k,k].forEach(function(v,x){v&&(r=r?r.then(function(){return b.lxSelect(x,v)}):b.lxSelect(x,v))});b.useGeocoder=!0;g.hide();e.html(i18n.location_found).removeClass("hide").show()}else g.hide(),d.html(i18n.location_not_found).removeClass("hide").show()},
error:function(k,l,q){k="UNAUTHORIZED"==q?i18n.gis_requires_login:k.responseText;g.hide();d.html(i18n.location_not_found).removeClass("hide").show();s3_debug(k)}})},_latlonInput:function(){var b=this.fieldname,a=this.data,d="#"+b,e=c(d+"_lat").val();d=c(d+"_lon").val();e||d?(e=e?parseFloat(e):0,d=d?parseFloat(d):0,a.lat=e,a.lon=d,a.wkt=null,this.input.data("manually_geocoded",!0)):(a.lat=null,a.lon=null,a.wkt||this.input.data("manually_geocoded",!1));this._serialize();e=S3.gis;e.maps&&(b=e.maps["location_selector_"+
b])&&(d=b.s3.draftLayer,d.removeAllFeatures(),null!==a.lat&&null!==a.lon&&(a=new OpenLayers.Geometry.Point(a.lon,a.lat),a.transform(e.proj4326,b.getProjectionObject()),a=new OpenLayers.Feature.Vector(a),d.addFeatures([a]),b.s3.lastDraftFeature=a),this._zoomMap())},_postcodeToAddress:function(){this._collectData();var b=this.fieldname,a=this,d="#"+b,e=this.data,g=e.postcode;if(g){c(d+"_address_menu").remove();var h=c(d+"_postcode__row .geocode_fail").hide(),k=c(d+"_postcode__row .throbber").removeClass("hide").show();
h.length||(c(d+"_postcode__row .columns").append('<div class="geocode_fail hide"></div>'),h=c(d+"_postcode__row .geocode_fail"));k.length||(c(d+"_postcode__row .columns").append('<div class="throbber"></div>'),k=c(d+"_postcode__row .throbber"));c.ajaxS3({url:S3.Ap.concat("/gis/postcode_to_address"),type:"POST",data:{postcode:g,k:a.postcodeToAddress},dataType:"json",success:function(l){var q=l.addresses;if(q&&q.length){k.hide();for(var p='<ul id="'+b+'_address_menu">',y=0;y<q.length;y++)p+="<li><div>"+
q[y]+"</div></li>";p+="</ul>";c(d+"_postcode").after(p);c(d+"_address_menu").menu({select:function(w,r){e.address=r.item[0].innerText;c(d+"_address").val(e.address);e.lat=parseFloat(l.lat);e.lon=parseFloat(l.lon);a._collectData();c(d+"_address__row").removeClass("hide").show();c(d+"_address__row1").removeClass("hide").show();c(d+"_address_menu").menu("destroy").remove();r=S3.gis;if(r.maps){var v=r.maps["location_selector_"+b];if(v){w=v.s3.draftLayer;w.removeAllFeatures();var x=new OpenLayers.Geometry.Point(e.lon,
e.lat);x.transform(r.proj4326,v.getProjectionObject());r=new OpenLayers.Feature.Vector(x);w.addFeatures([r]);a._zoomMap()}}w=l.L0;r=l.L1;v=l.L2;x=l.L3;var A=l.L4,z=l.L5;if(w){var B;[w,r||v,v||x,x||A,A||z,z].forEach(function(D,C){D&&(B=B?B.then(function(){return a.lxSelect(C,D,!0)}):a.lxSelect(C,D,!0))})}}})}else k.hide(),h.html(i18n.no_addresses_found).removeClass("hide").show(),s3_debug(l)},error:function(l,q,p){l="UNAUTHORIZED"==p?i18n.gis_requires_login:l.responseText;k.hide();h.html(l).removeClass("hide").show();
s3_debug(l)}})}},_showMap:function(b){var a=this.fieldname,d=this.eventNamespace,e=this,g="#"+a;c(g+"_map_icon").unbind(d).bind("click"+d,function(){e._hideMap()});c(g+"_map_icon span").html(i18n.hide_map);d=c(g+"_map_wrapper").hide().removeClass("hide").slideDown("medium");d.length&&b&&c("html,body").animate({scrollTop:d.offset().top},250);var h=this.input;c.when(this._jsLoaded()).then(function(){var k=S3.gis,l="location_selector_"+a;var q=k.maps[l]?k.maps[l]:k.show_map(l);e._zoomMap();var p=e.data;
l=p.lat;var y=p.lon,w=p.wkt;if(l||y||w)q.s3.draftLayer.removeAllFeatures(),w!=t&&w?(l={internalProjection:q.getProjectionObject(),externalProjection:k.proj4326},l=(new OpenLayers.Format.WKT(l)).read(w)):(l=new OpenLayers.Geometry.Point(parseFloat(y),parseFloat(l)),l.transform(k.proj4326,q.getProjectionObject()),l=new OpenLayers.Feature.Vector(l)),q.s3.draftLayer.addFeatures([l]),q.s3.lastDraftFeature=l;l=q.controls;y=0;for(var r=l.length;y<r;y++)if("OpenLayers.Control.DrawFeature"==l[y].CLASS_NAME){var v=
l[y];break}v&&(q.s3.pointPlaced=function(x){c(g+"_geocode .geocode_fail").hide();c(g+"_geocode .geocode_success").hide();var A=x.geometry;if("OpenLayers.Geometry.Point"==A.CLASS_NAME)x=A.getBounds().getCenterLonLat(),x.transform(q.getProjectionObject(),k.proj4326),p.wkt=null,p.lat=x.lat,p.lon=x.lon,!p.address&&e.useGeocoder&&e._geocodeReverse();else{A={internalProjection:q.getProjectionObject(),externalProjection:k.proj4326};p.radius=null;var z=new OpenLayers.Geometry.LinearRing(x.geometry.components[0].components);
z=new OpenLayers.Geometry.Polygon([z]);if(1E3==z.getVertices().length){var B=(new OpenLayers.Feature.Vector(z,null)).geometry.getBounds();z=B.right;var D=(B.bottom+B.top)/2;B=new OpenLayers.Geometry.Point((B.left+z)/2,D);z=new OpenLayers.Geometry.Point(z,D);z=new OpenLayers.Geometry.LineString([B,z]);z=parseFloat(z.getLength());p.radius=z}w=(new OpenLayers.Format.WKT(A)).write(x);p.wkt=w;p.lat=null;p.lon=null}h.data("manually_geocoded",!0);e._collectData(!0);e._removeErrors();"sub_"==a.substring(0,
4)&&h.parent().find("div.map_wrapper").trigger("change")})},function(k){s3_debug(k)},function(k){s3_debug(k)})},_hideMap:function(){var b=this.fieldname,a=this.eventNamespace,d="#"+b,e=this;c(d+"_map_icon").unbind(a).bind("click"+a,function(h){e._showMap(h)});c(d+"_map_wrapper").slideUp("medium");a=this.data;if(a.specific)var g=i18n.show_map_view;else if(g=i18n.show_map_add,S3.gis.maps&&(b=S3.gis.maps["location_selector_"+b]))b.s3.draftLayer.removeAllFeatures(),a.lat=null,a.lon=null,a.wkt=null,this.input.data("manually_geocoded",
!1),this._collectData();c(d+"_map_icon span").html(g)},_zoomMap:function(b){var a=this.fieldname,d=S3.gis;if(d.maps&&(a=d.maps["location_selector_"+a])){var e=this.data;d=e.lat;var g=e.lon;e=e.wkt;if(d&&g)d=OpenLayers.Bounds.fromArray([g,d,g,d]);else if(e)d=(new OpenLayers.Feature.Vector(OpenLayers.Geometry.fromWKT(e))).geometry.getBounds();else{b||(b=this._lookupParent()||"d");d=f[b].b;if(!d||!d.length)for(g=f[b].f,b=4;g&&b&&(b--,g=f[g],!(d=g.b)&&0!==g.l);)g=g.f;d&&(d=OpenLayers.Bounds.fromArray(d))}d&&
S3.gis.zoomBounds(a,d,this.options.minBBOX)}},_validate:function(){var b=this.fieldname;this._removeErrors();var a="#"+b,d=this.data;if(b=this.options.featureRequired){var e=!1;switch(b){case "latlon":e=d.lat||d.lon;break;case "wkt":e=d.wkt;break;default:e=d.lat||d.lon||d.wkt}if(!e)return this._fieldError(c(a+"_map_icon"),i18n.map_feature_required),!1}var g=function(p){return p.hasClass("multiselect")?p.next("button.ui-multiselect").is(":visible"):p.is(":visible")},h=!1;b="L5 L4 L3 L2 L1 L0".split(" ");
for(e=0;6>e;e++){var k=b[e];var l=a+"_"+k;var q=c(l);if(q.length&&q.hasClass("required")&&g(q)&&!d[k]){this._fieldError(q,i18n.enter_value);h=!0;break}}["address","postcode"].forEach(function(p){l=a+"_"+p;q=c(l);q.length&&q.hasClass("required")&&g(q)&&!d[p]&&(this._fieldError(q,i18n.enter_value),h=!0)},this);return!h},_serialize:function(){var b=JSON.stringify(this.data);this.input.val(b);return b},_deserialize:function(){var b=this.input.val();return this.data=JSON.parse(b)},_storeHierarchyData:function(b,
a){var d;if(a)for(d in a)f[d]=a[d];if(b)for(d in b)m[d]=b[d]},_jsLoaded:function(){var b=new jQuery.Deferred;setTimeout(function d(){S3.gis.maps!=t?b.resolve("loaded"):"pending"===b.state()&&(b.notify("waiting for JS to load..."),setTimeout(d,500))},1);return b.promise()},_fieldError:function(b,a){b.addClass("invalidinput").after('<div class="error" style="display: block;">'+a+"</div>");c(".invalidinput").get(0).scrollIntoView()},_removeErrors:function(b){b||(b="#"+this.fieldname,b=b+"_L0,"+b+"_L1,"+
b+"_L2,"+b+"_L3,"+b+"_L4,"+b+"_L5,"+b+"_address,"+b+"_postcode,"+b+"_map_icon");c(b).removeClass("invalidinput").siblings(".error").remove()},_bindEvents:function(){var b=this.fieldname,a=this.eventNamespace,d=this,e="#"+b;c(e+"_L0").bind("change"+a,function(){d._removeErrors(this);d.lxSelect(0)});c(e+"_L1").bind("change"+a,function(){d._removeErrors(this);d.lxSelect(1)});c(e+"_L2").bind("change"+a,function(){d._removeErrors(this);d.lxSelect(2)});c(e+"_L3").bind("change"+a,function(){d._removeErrors(this);
d.lxSelect(3)});c(e+"_L4").bind("change"+a,function(){d._removeErrors(this);d.lxSelect(4)});c(e+"_L5").bind("change"+a,function(){d._removeErrors(this);d.lxSelect(5)});c(e+"_address").bind("change"+a,function(){d._removeErrors(this);d.useGeocoder?d._geocodeDecision():d._collectData()});c(e+"_postcode").bind("change"+a,function(){d._removeErrors(this);d.useGeocoder?d._geocodeDecision():d.postcodeToAddress?d._postcodeToAddress():d._collectData()});c(e+"_lat,"+e+"_lon").bind("change"+a,function(){d._latlonInput()});
c(e+"_latlon_toggle").bind("click"+a,function(){var h=c(this).data("mode")||d.options.latlonMode;if("dms"==h){h="decimal";var k=i18n.latlon_mode.dms}else h="dms",k=i18n.latlon_mode.decimal;c(e+"_lat").latloninput("option",{mode:h});c(e+"_lon").latloninput("option",{mode:h});c(this).html(k).data("mode",h)});if("sub_"==b.substring(0,4))this.input.closest(".inline-form").bind("validate"+a+this.id,function(h){d._validate()||h.preventDefault()});else{var g=this.input.closest("form");g.bind("submit"+a+
this.id,function(h){h.preventDefault();d._validate()&&g.unbind(a+d.id).submit()})}return!0},_unbindEvents:function(){var b="#"+this.fieldname,a=this.eventNamespace;c(b+"_L0,"+b+"_L1,"+b+"_L2,"+b+"_L3,"+b+"_L4,"+b+"_L5,"+b+"_address,"+b+"_postcode,"+b+"_map_icon,"+b+"_latlon_toggle").unbind(a);this.input.next(".error_wrapper").unbind(a);this.input.closest("form").unbind(a+this.id);return!0}})})(jQuery);
(function(c,t){var u=0;c.widget("s3.latloninput",{options:{type:"lat",mode:"decimal",labels:{deg:"\u00b0",min:"'",sec:'"'}},_create:function(){this.id=u;u+=1;this.eventNamespace=".latloninput"},_init:function(){c(this.element).hide();this.refresh()},_destroy:function(){c(this.element).show();c.Widget.prototype.destroy.call(this)},_setOption:function(f,m){this._super(f,m);"mode"==f&&this.refresh()},refresh:function(){this._unbindEvents();var f=c(this.element),m=this.options;this.defaultValue=f.val();
if(!this.input){var n=c("<div>").hide().insertAfter(f),b=c('<input type="text" class="dms-input" size="18">').hide();this.decimalInput=b;var a=m.labels,d=c('<input type="text" class="integer dms-input" size="5">'),e=c('<span class="dms-label">'+a.deg+"</span>"),g=c('<input type="text" class="integer dms-input" size="5">'),h=c('<span class="dms-label">'+a.min+"</span>"),k=c('<input type="text" class="double dms-input" size="8">');a=c('<span class="dms-label">'+a.sec+"</span>");this.degInput=d;this.minInput=
g;this.secInput=k;this.dmsInput=d=c("<span>").append(d).append(e).append(g).append(h).append(k).append(a).hide();this.input=n.append(b).append(d).show()}this._removeErrors();"dms"==m.mode?(f=this._getDMS(),this.degInput.val(f.d),this.minInput.val(f.m),this.secInput.val(f.s),this.decimalInput.hide(),this.dmsInput.show()):(this.decimalInput.val(f.val()),this.dmsInput.hide(),this.decimalInput.show());this._bindEvents()},_getDMS:function(){var f=c(this.element).val();if(isNaN(parseFloat(f))||!isFinite(f))return{d:"",
m:"",s:""};var m=Math.abs(f);m=60*(m-parseInt(m,10));if(1E-10>Math.abs(m-Math.round(m))){m=Math.round(m);var n=0}else n=60*(m-parseInt(m,10)),1E-10>Math.abs(n-Math.round(n))&&(n=Math.round(n));return{d:parseInt(f,10),m:parseInt(m,10),s:n}},_showError:function(f,m){"all"==f?this.input.find("input").addClass("invalidinput"):f&&f.addClass("invalidinput");m&&this.input.append('<div class="error">'+m+"</div>")},_removeErrors:function(){this.input.find("input").removeClass("invalidinput");this.input.find(".error").remove()},
_validateDMS:function(){this._removeErrors();if("lat"==this.options.type){var f=90;var m=i18n.latlon_error.lat}else f=180,m=i18n.latlon_error.lon;var n=this.degInput.val(),b=this.minInput.val(),a=this.secInput.val(),d=[];if(""===n&&""===b&&""===a)return"";n=parseInt(n,10)||0;b=parseInt(b,10)||0;a=parseFloat(a)||0;60<=Math.abs(b)&&(this._showError(this.minInput),d.push(i18n.latlon_error.min));60<=Math.abs(a)&&(this._showError(this.secInput),d.push(i18n.latlon_error.sec));b=Math.abs(n)+b/60+a/3600;
if(!d.length&&b>f||n>f)this._showError("all"),d.push(m);return d.length?(this._showError(null,d.join(", ")),null):(0>n?-1:1)*b},_validateDecimal:function(){this._removeErrors();var f=this.options.type,m=i18n.latlon_error.format;if("lat"==f){var n=90;var b=i18n.latlon_error.lat}else n=180,b=i18n.latlon_error.lon;var a=this.decimalInput.val();if(""===a)return"";a=this._parse(a,f);null===a?this._showError(this.decimalInput,m):Math.abs(a)>n&&(this._showError(this.decimalInput,b),a=null);return a},_parse:function(f,
m){var n="lat"==m?{N:1,S:-1}:{E:1,W:-1};var b=/^([NSEW]{0,1})\s*([-+]?\d+[.,]?\d*)\s*\u00b0?\s*([NSEW])?\s*$/,a=/^([NSEW]{0,1})\s*([-+]?\d+[.,]?\d*)?\s*([\u00b0'"]{0,1})\s*:?\s*([-+]?\d+[.,]?\d*)?\s*(['"]{0,1})\s*:?\s*([-+]?\d+[.,]?\d*)?\s*(['"]{0,1})\s*([NSEW])?\s*$/,d=m=0,e=0;if(f.match(b))return a=f.replace(b,"$1|$2|$3").split("|"),(f=a[0]||a[2])&&(f=n[f]),m=parseFloat(a[1]),f&&Math.abs(m)!=m&&(f=null),f&&(m*=f),m;if(f.match(a)){a=f.replace(a,"$1|$2|$3|$4|$5|$6|$7|$8").split("|");(f=a[0]||a[7])&&
(f=n[f]);n=[];b=[];var g,h;for(h=1;6>h;h+=2){var k=a[h];(g=a[h+1])?(n.push(parseFloat(k)||0),b.push(g)):k&&(n.push(parseFloat(k)),b.push(null))}if(a=n.length){for(h=1;h<a;h++)n[h]=Math.abs(n[h]);k=n[0];Math.abs(k)!=k&&(f=1);if(1==a)g=b[0],'"'==g?e=n[0]:"'"==g?d=n[0]:g&&"\u00b0"!=g||(m=n[0]);else if(2==a)if(a=b[0],b=b[1],"\u00b0"==a)m=n[0],'"'==b?e=n[1]:"'"!=b&&b||(d=n[1]);else if(a){if("'"!=a||b&&'"'!=b)return null;d=n[0];e=n[1]}else'"'==b?(d=n[0],e=n[1]):"'"!=b&&b||(m=n[0],d=n[1]);else{if(b[0]&&
"\u00b0"!=b[0]||b[1]&&"'"!=b[1]||b[2]&&'"'!=b[2])return null;m=n[0];d=n[1];e=n[2]}m=m+d/60+e/3600;f&&(m*=f);return m}}return null},_bindEvents:function(){var f=this,m=this.eventNamespace;this.dmsInput.find("input").bind("change"+m,function(){var n=f._validateDMS();null!==n?c(f.element).val(n).change():c(f.element).val(f.defaultValue).change()});this.decimalInput.bind("change"+m,function(){var n=f._validateDecimal();null!==n?(c(f.element).val(n).change(),f.decimalInput.val(n)):c(f.element).val(f.defaultValue).change()});
c(this.element).bind("setvalue"+m,function(){f.refresh()});return!0},_unbindEvents:function(){var f=this.eventNamespace;this.input&&this.input.find("input").unbind(f);c(this.element).unbind(f);return!0}})})(jQuery);
